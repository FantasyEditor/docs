# 法球

幻想编辑器对法球的定义是，附带在一次施法流程中的完整效果。一开始要理解完整的法球可能有点困难，所以这里暴击的实现为例子，帮助你理解幻想编辑器的法球。

在幻想编辑器中没有提供原生的暴击支持，因为要实现一个简单的暴击相当的简单。首先添加两个自定义单位属性`暴击`和`暴击伤害`，然后为需要暴击的单位注册一个伤害函数

``` lua
u:event('造成伤害', function(_, dmg)
  if u:get '暴击' >= math.random(1, 100) then
    dmg.damage = dmg.damage * u:get '暴击伤害'
  end
end)  
```

> 假如我希望技能在暴击和不暴击时用的单位用不同的动画，怎么办？

暴击时要用不同的动画，而动画在施法开始时就开始播放了，所以我们必须在施法开始时就决定，本次施法是否会暴击。注意我这里说的是`施法`而不是`伤害`。

> 为什么是施法而不是伤害？

如果你接触过其它编辑器，你可能会在潜意识中认为暴击指的普通攻击的暴击。但我这里说的是任意技能的暴击，而普通攻击的暴击只是技能暴击的一个子集。普通攻击的一次施法只会对应一个伤害，而技能一次施法可能会对应很多个伤害（比如AOE）。当单位用了一个暴击的施法动画，你当然是希望此次施法的所有伤害都是暴击了。

所以实现会变成这样

``` lua
u:event('单位-施法开始', function(_, skl)
  if u:get '暴击' >= math.random(1, 100) then
    skl['暴击'] = true
    -- 修改动画
  end
end)
u:event('造成伤害', function(_, dmg)
  if dmg.skill['暴击'] then
    dmg.damage = dmg.damage * u:get '暴击伤害'
  end
end) 
```

> 如果要做只会暴击一次的暴击如何做呢？

你可以有一个计数，在单位上或者在技能上，决定这个单位还能暴击几次。但问题的关键是这个计数在什么时候减一。如果在判断暴击之后就马上减一，那么这个技能在出手之前被打断了，那么这个暴击就没了。所以在施法出手时减一是更好的选择。于是我们再次改造下实现


``` lua
u:event('单位-施法开始', function(_, skl)
  if u['下一次施法可能暴击'] then
    if u:get '暴击' >= math.random(1, 100) then
      skl['暴击'] = true
      -- 修改动画
    end
  end
end)
u:event('单位-施法出手', function(_, skl)
  if skl['暴击'] then
    u['下一次施法可能暴击'] = false
  end
end)
u:event('造成伤害', function(_, dmg)
  if dmg.skill['暴击'] then
    dmg.damage = dmg.damage * u:get '暴击伤害'
  end
end) 
```

暴击的演示只是想说明做一个法球会遇到哪些问题，现在我们来看看用幻想编辑器的法球系统如何来实现这个暴击。

``` lua
local mt = ac.orb_buff['下一次施法可能暴击']

mt.orb_count = 1

function mt:on_start(skl)
  if u:get '暴击' >= math.random(1, 100) then
    -- 修改动画
    return true
  end
end

function mt:on_hit(dmg)
    dmg.damage = dmg.damage * u:get '暴击伤害'
end
```

法球是一个模板状态，只要把这个状态添加给单位，单位的下一次施法就会有可能暴击，直到暴击一次。

> 如何使用法球？

法球状态依赖于外部给它提供的四个事件

* 伤害初始化
* 伤害前效果
* 法球开始
* 法球出手

其中 `伤害初始化`和`伤害前效果`在脚本库的伤害结算中已经实现。而脚本库也帮你实现了针对普通攻击的`法球开始`和`法球出手`事件。所以对于普通攻击，不需要做任何修改就可以直接支持。对于技能，默认情况下不支持法球。当然你要开始技能对法球的支持也很简单，只需要在`施法开始`和`施法出手`时分别分发`法球开始`和`法球出手`事件即可。

换而言之，只有分发了`法球开始`和`法球出手`的技能才支持法球。

这便于你区别哪些技能需要法球哪些不需要。你也可以让所有技能都支持法球，就像这样

``` lua
ac.game:event('单位-施法开始', function(_, u, skl)
  u:event_notify('法球开始', skl)
end)
ac.game:event('单位-施法出手', function(_, u, skl)
  u:event_notify('法球出手', skl)
end)
```

## 进阶学习：法球施法表

法球施法表是一个只在法球里定义的概念。在我们用法球实现暴击的例子中on_start的第一个参数以及法球开始/法球出手事件的第一个参数都是法球施法表。

> 不是施法表吗？

法球只要求在一次法球结算中使用同一张表，并没有对这个表是什么作出要求，而这个表我们称之为法球施法表。换而言之，只要是同一个表的地方都会被视为同一次法球结算。而在脚本库提供的法球支持中，法球施法表使用的正是`施法`对象，所以同一次施法才会被视为同一次法球。

## 进阶学习：属性表

在法球的开始阶段和出手阶段，我们无法对伤害做任何修改，因为这时候伤害还不存在。而法球的属性表则是给你提供了另一种解决办法，你可以简单地把它理解为一个提前创建出来的伤害。因为法球会在每次真正的伤害被创建是，把属性表里的值复制到伤害上。这样就可以做到提前修改伤害的效果。

依然是之前的例子，我利用属性表作了一些修改，思考一下这样写有什么好处。

``` lua
local mt = ac.orb_buff['暴击']

mt.orb_count = 1

function mt:on_start(_, t)
  if u:get '暴击' >= math.random(1, 100) then
    t['暴击'] = u:get '暴击伤害'
    -- 修改动画
    return true
  end
end

function mt:on_hit(dmg)
    dmg.damage = dmg.damage * dmg['暴击伤害']
end
```

比如一般来说暴击和暴击伤害都是由相同的装备/状态来提供的，假如这个装备/状态在施法过程中失去，你就会看到一个暴击了，但伤害却没有变化的暴击。所以利用属性表将暴击伤害提前准备好，是一个更严谨的写法。
